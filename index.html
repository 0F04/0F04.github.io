<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2018-06-04 Mon 17:03 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EASY TALK</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="0F04" />
<meta name="description" content="THINGS I WANNA TALK ABOUT"
 />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://www.pirilampo.org/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://www.pirilampo.org/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/lib/js/jquery.stickytableheaders.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">EASY TALK</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org0d322d4">1. Kernel</a>
<ul>
<li><a href="#org89653eb">1.1. Hiding a kernel malicious module.</a></li>
</ul>
</li>
<li><a href="#org153d566">2. Documentation efforts.</a></li>
<li><a href="#org1087f96">3. The time I almost got training.</a>
<ul>
<li><a href="#orgd02dbe1">3.1. Day 0</a>
<ul>
<li><a href="#orgcc91058">Introduction and reason:</a></li>
<li><a href="#org76ce930">Day 0 (Background information)</a>
<ul>
<li><a href="#orgf5eb860">How the stack works</a></li>
<li><a href="#orgbd52e3a">Understanding a kernel stack trace.</a></li>
<li><a href="#org5817024">Userland vs kernel land.</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org63e418e">3.2. Day +1 (Preparation)</a>
<ul>
<li><a href="#org2fbe394">Setting up a kernel debugging environment</a>
<ul>
<li><a href="#org067f3b7">Setting up the kernel to be debugged.</a></li>
</ul>
</li>
<li><a href="#orgcb5327a">Kernel internals</a>
<ul>
<li><a href="#orgb083ff3">Memory models and the address space</a></li>
<li><a href="#org562fdbc">Device drivers</a></li>
</ul>
</li>
<li><a href="#org77f10b7">Flaw types</a>
<ul>
<li><a href="#org6e924c4">Infoleak</a></li>
<li><a href="#org02ba814">Privesc</a></li>
<li><a href="#orgfb80889">X86 calling conventions.</a></li>
<li><a href="#org78470a5">Key structures in privesc</a></li>
</ul>
</li>
<li><a href="#org1cf553a">Exploit stages</a>
<ul>
<li><a href="#orga7d59fd">Was reading a book about the 4 stages of exploitation, cover that here.</a></li>
</ul>
</li>
<li><a href="#org6239f67">Common C Exploit types</a></li>
<li><a href="#orgecfdb94">Kernel Mitigations</a>
<ul>
<li><a href="#org89dfa71">Stack guard page.</a></li>
<li><a href="#orga8ebdd2">SMEP</a></li>
<li><a href="#org1dc16e0">SMAP</a></li>
<li><a href="#org4036ef4">Struct alignment.</a></li>
<li><a href="#org23eaee5">Hardening list ?</a></li>
<li><a href="#orge8fc986">Seccomp sandboxing</a></li>
<li><a href="#org5c03c37">address<sub>limit</sub> checks</a></li>
<li><a href="#orgef2fc6f">Probable mitigations can be destroyed with rowhammer exploits or the newer</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgd6715ec">3.3. Day +2 (Exploit toolchain)</a>
<ul>
<li><a href="#orga586c6e">Abusing arbitrary read/write</a></li>
<li><a href="#orgf6480a2">Abusing function pointers</a></li>
<li><a href="#org8d03182">Controlled memory 'corruption'</a>
<ul>
<li><a href="#orgb8b4372"><span class="todo TODO">TODO</span> create example of writing 'something' to a location, then spinning on</a></li>
</ul>
</li>
<li><a href="#org995fa00">Simple Race conditions</a></li>
</ul>
</li>
<li><a href="#org0dcefee">3.4. Day +3</a>
<ul>
<li><a href="#org4c9ed56">Logical and hardware related bugs</a>
<ul>
<li><a href="#orge891a75">CDROM infoleak ?</a></li>
</ul>
</li>
<li><a href="#org64305b6">Kernel and hardware protection</a></li>
<li><a href="#org5644a31">Bypassing protections</a></li>
<li><a href="#org58b8b9f">The future of kernel vulnerabilties</a></li>
</ul>
</li>
<li><a href="#org7feb170">3.5. Day +4 (Stuff that Doesn't fit )</a>
<ul>
<li><a href="#org430cde2">Rootkits</a>
<ul>
<li><a href="#org11904b6">Tricks:</a></li>
</ul>
</li>
<li><a href="#orga4b9591">Basic commit creds example:</a></li>
</ul>
</li>
<li><a href="#orgadc66c5">3.6. References / to sort.</a></li>
</ul>
</li>
</ul>
</div>
</div>


<div id="outline-container-org0d322d4" class="outline-2">
<h2 id="org0d322d4"><span class="section-number-2">1</span> Kernel</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org89653eb" class="outline-3">
<h3 id="org89653eb"><span class="section-number-3">1.1</span> Hiding a kernel malicious module.</h3>
</div>
</div>


<div id="outline-container-org153d566" class="outline-2">
<h2 id="org153d566"><span class="section-number-2">2</span> Documentation efforts.</h2>
</div>
<div id="outline-container-org1087f96" class="outline-2">
<h2 id="org1087f96"><span class="section-number-2">3</span> The time I almost got training.</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgd02dbe1" class="outline-3">
<h3 id="orgd02dbe1"><span class="section-number-3">3.1</span> Day 0</h3>
<div class="outline-text-3" id="text-3-1">
</div>
<div id="outline-container-orgcc91058" class="outline-4">
<h4 id="orgcc91058">Introduction and reason:</h4>
<div class="outline-text-4" id="text-orgcc91058">
<p>
This is a learning preparedness series for my journey to infiltrate2018 for 
"master track: kernel exploitation".  As work could neither justify my
attendence or give time off for me to go, this is for perhaps someone elses 
assistance.
</p>

<p>
Here I will break down any resources and clarify my understanding in my own
words to ensure that I document my understanding and that I am not wasting time
and money.
</p>

<p>
I want to build practical examples that I can read and reference at a later
date.
</p>

<p>
I've broken down the data from <a href="https://infiltratecon.com/schedule/">https://infiltratecon.com/schedule/</a> into the
days that information is being presented, I want to do research into each of
the topics and make this as fruitful as possible.
</p>
</div>
</div>

<div id="outline-container-org76ce930" class="outline-4">
<h4 id="org76ce930">Day 0 (Background information)</h4>
<div class="outline-text-4" id="text-org76ce930">
</div>
<div id="outline-container-orgf5eb860" class="outline-5">
<h5 id="orgf5eb860">How the stack works</h5>
<div class="outline-text-5" id="text-orgf5eb860">
<p>
Draw from:
<a href="http://badbytes.io/2017/02/15/exploit-dev-0x01-64-bit-linux-stack-buffer-overflow/">http://badbytes.io/2017/02/15/exploit-dev-0x01-64-bit-linux-stack-buffer-overflow/</a>
</p>
</div>
</div>

<div id="outline-container-orgbd52e3a" class="outline-5">
<h5 id="orgbd52e3a">Understanding a kernel stack trace.</h5>
<div class="outline-text-5" id="text-orgbd52e3a">
<p>
When you get a backtrace you may see something similar to the below:
</p>

<pre class="example">
[  509.617661] BUG: unable to handle kernel NULL pointer dereference at 0000000000000028

                [&lt;ffffffffc0599a80&gt;] drbg_kcapi_reset+0x160/0x220 [drbg] 
[  509.642461]  [&lt;ffffffff812eb867&gt;] rngapi_reset+0x57/0x80
[  509.642461]  [&lt;ffffffffc05c400f&gt;] rng_setkey+0xf/0x20 [algif_rng]
[  509.642461]  [&lt;ffffffff812ec131&gt;] alg_setsockopt+0x101/0x140
[  509.642461]  [&lt;ffffffff8156b3a0&gt;] SyS_setsockopt+0x80/0xf0
[  509.642461]  [&lt;ffffffff816b4fc9&gt;] system_call_fastpath+0x16/0x1b


[  509.642461] RAX: 0000000000000010 RBX: ffff8800b37a3c00 RCX: 000000000000000a
[  509.642461] RAX: 0000000000000010 RBX: ffff8800b37a3c00 RCX: 000000000000000a
[  509.642461] RDX: 000000000000000a RSI: ffffffffc059b6f6 RDI: ffffffffc059dae2
[  509.642461] RBP: ffff880137847ea8 R08: 0000000000000036 R09: 0000000000000000
[  509.642461] R10: ffff88013fc19ba0 R11: ffffea00022ac900 R12: ffffffffc059dae2
[  509.642461] R13: 000000000000000b R14: ffffffffc059b6f6 R15: 000000000000000a
</pre>

<p>
Kernel stack traces read "bottom up", the most recently executing function is
at the top, followed by the function that called that, followed by the function
that called and so on.
</p>

<p>
To break down a single line:
</p>

<pre class="example">
Each line explained:

                [&lt;ffffffffc0599a80&gt;] drbg_kcapi_reset+0x160/0x220 [drbg] 
                 ^1                  ^2               ^3    ^4    ^5
</pre>

<p>
Below, each element is explained:
</p>

<ol class="org-ol">
<li>Physical location of memory where this is being run, should be kernel address space.</li>
<li>Name of the function that the kernel "thinks" its in.</li>
<li>Offset from the start of the function that the 'unwinder' could match.</li>
<li>Length of the function that the 'unwinder' could match to.</li>
<li>Optional, kernel module name.</li>
</ol>

<p>
From the above we can see that the kernel paniced while in drbg<sub>kcapi</sub><sub>reset</sub> at
offset 0x160 through the function..  We're going to show a method in this case
to confirm that the stack trace is working how we assume it is.
</p>

<p>
Examples within are in the intel assembly format because that is what I feel
more comfortable with.
</p>

<p>
Lets start by using objdump on the module to see the assembly instruction that
the kernel paniced on:
</p>

<pre class="example">

$ objdump -dSLR -M intel drbg.ko |grep drbg_kcapi_reset | grep -A 25 

static int drbg_kcapi_reset(struct crypto_rng *tfm, u8 *seed, unsigned int slen)

0000000000002920 

 2a5d:       41 83 ff 0b             cmp    r15d,0xb
 2a61:       75 dd                   jne    2a40 &lt;drbg_kcapi_reset+0x120&gt;
 2a63:       45 30 ff                xor    r15b,r15b
 2a66:       8b 45 98                mov    eax,DWORD PTR [rbp-0x68]
 2a69:       85 c0                   test   eax,eax
 2a6b:       0f 85 97 00 00 00       jne    2b08 &lt;drbg_kcapi_reset+0x1e8&gt;
 2a71:       48 83 7d a0 00          cmp    QWORD PTR [rbp-0x60],0x0
 2a76:       0f 84 a4 00 00 00       je     2b20 &lt;drbg_kcapi_reset+0x200&gt;
 2a7c:       48 8b 45 a0             mov    rax,QWORD PTR [rbp-0x60]
 2a80:       4c 8b 60 18             mov    r12,QWORD PTR [rax+0x18] &lt;&lt;== HERE
 2a84:       4d 85 e4                test   r12,r12                  
 2a87:       74 22                   je     2aab &lt;drbg_kcapi_reset+0x18b&gt;
 2a89:       49 83 3c 24 00          cmp    QWORD PTR [r12],0x0
 2a8e:       74 1b                   je     2aab &lt;drbg_kcapi_reset+0x18b&gt;
 2a90:       4c 8b 75 a8             mov    r14,QWORD PTR [rbp-0x58]

</pre>

<p>
So to find the instruction it bugged on: 
</p>

<pre class="example">
  0x2920 (function offset) 
+ 0x0160 (instruction offset)
========
  0x2a80
========
</pre>

<p>
We can see that this bugged on mov r12,QWORD PTR[rax+0x18]. This kind of
instruction is usually used when looking up elements of a struct.
</p>

<p>
We do notice however that the backtrace mentions 0x28, but the assembly
instruction mentions 0x10, what gives.. well thats because the RAX 
register contains 0x10 (See stack dump above).  RAX + 0x18, added together 
giveth 0x28.
</p>

<p>
Timesaver:
</p>

<p>
If you ever need to do hex math you can use python 
</p>

<pre class="example">
python
&gt;&gt; hex (0x2920 + 0x160)
0x2a80
&gt;&gt; hex (0x18 + 0x1000)
0x28
</pre>

<p>
Fortunately, we have the source code, so we can use the previous in
confirm what line was being bugged.
</p>

<p>
The addr2line or "eu-addr2line" tool is able to translate the function+offset
into a line number.   You may need to use your kernels "debug" modules or
"debuginfo" modules to correctly determine the offset information as not all
modules will have sufficient debugging symbols present to determine which line
is being executed.  
</p>

<p>
Shown below is the RHEL7 drbg.ko module from kernel-debuginfo.  It is important
to run this against the matching kernel release or the line values will not
match correctly.
</p>


<pre class="example">
[wmealing@linux Downloads]$  eu-addr2line -f -e  ./usr/lib/debug/lib/modules/3.10.0-691.el7.x86_64/kernel/crypto/drbg.ko.debug 
drbg_kcapi_reset+0x160
drbg_kcapi_reset
crypto/drbg.c:1741

</pre>

<p>
We get a little closer, so lets take a look at that line:
</p>

<pre class="example">
1722 static int drbg_kcapi_reset(struct crypto_rng *tfm, u8 *seed, unsigned int slen)
1723 {
1724         struct drbg_state *drbg = crypto_rng_ctx(tfm);
1725         struct crypto_tfm *tfm_base = crypto_rng_tfm(tfm);
1726         bool pr = false;
1727         struct drbg_string seed_string;
1728         int coreref = 0;
1729 
1730         drbg_uninstantiate(drbg);
1731         drbg_convert_tfm_core(crypto_tfm_alg_driver_name(tfm_base), &amp;coreref,
1732                               &amp;pr);
1733         if (0 &lt; slen) {
1734                 drbg_string_fill(&amp;seed_string, seed, slen);
1735                 return drbg_instantiate(drbg, &amp;seed_string, coreref, pr);
1736         } else {
1737                 struct drbg_gen *data = (struct drbg_gen *)seed;
1738                 /* allow invocation of API call with NULL, 0 */
1739                 if (!data)
1740                         return drbg_instantiate(drbg, NULL, coreref, pr);
1741                 drbg_set_testdata(drbg, data-&gt;test_data); &lt;-- HERE
1742                 /* linked list variable is now local to allow modification */
1743                 drbg_string_fill(&amp;seed_string, data-&gt;addtl-&gt;buf,
1744                                  data-&gt;addtl-&gt;len);
1745                 return drbg_instantiate(drbg, &amp;seed_string, coreref, pr);
1746         }
1747 }
</pre>

<p>
Because we can see that its trying to find the offset of a specific item (with
rax+0x18 in the instruction) we can take a pretty good guess that its looking
at data-&gt;test<sub>data</sub>.
</p>

<p>
The drbg<sub>set</sub><sub>testdata</sub> function is an "inline" function.  This means that the
kernel function will not include the usual "call" assembly instruction to
execute the function, but instead will put the code that the function would
execute directly in-place.
</p>

<p>
Because of this, We can match the first instruction of the drbg<sub>set</sub><sub>testdata</sub>
function with the next instruction of the dissasembly.
</p>

<p>
This first instruction is a testing that the first arguent is "not null", this
is acheived in assembly with the "test" instruction.  
</p>

<pre class="example" id="Test instruction.">
test r12 r12
</pre>

<p>
We can backtrack to the previous instruction and determine that the result was
stored in R12 to see if we are likely in the correc tlocation
</p>

<pre class="example" id="pointer-dereference instruction.">
2a80:       4c 8b 60 18             mov    r12,QWORD PTR [rax+0x18]
</pre>

<p>
References:
 <a href="https://stackoverflow.com/questions/6151538/addr2line-on-kernel-module">https://stackoverflow.com/questions/6151538/addr2line-on-kernel-module</a>
</p>
</div>
</div>

<div id="outline-container-org5817024" class="outline-5">
<h5 id="org5817024">Userland vs kernel land.</h5>
<div class="outline-text-5" id="text-org5817024">
</div>
<ul class="org-ul">
<li><a id="orge26f8a1"></a>What is userspace:<br />
<div class="outline-text-6" id="text-orge26f8a1">
<p>
Userspace is an area of memory reserved for applications that run on behalf
of users to execute.  It has a contiguous section of memory of a subsection of
the full memory available
</p>

<p>
mention pte&#x2026; abstraction.
virtual address space uses page tables to look things up.
</p>

<ul class="org-ul">
<li>syscalls explain context</li>
<li>ioctls explain context</li>
</ul>
</div>
</li>

<li><a id="org211dde6"></a>What is a syscall?<br />
<div class="outline-text-6" id="text-org211dde6">
<p>
A system call, sometimes referred to as a kernel call, is a request in a
Unix-like operating system made via a software interrupt by an active 
process for a service performed by the kernel.
</p>

<p>
Link to any POSIX spec for syscalls or doc on syscalls ?
</p>
</div>
</li>

<li><a id="org2e9e6ee"></a>What is an ioctl ?<br />
<div class="outline-text-6" id="text-org2e9e6ee">
<p>
An ioctl (an abbreviation of input/output control) is a system call for 
device-specific input/output operations and other operations which cannot be
expressed by regular system calls.  Usually these control hardware.
</p>

<p>
Link to any discussion on deprecation of ioctls to other mechanisms.
</p>

<pre class="example">

#include &lt;fcntl.h&gt;      /* open */ 
#include &lt;unistd.h&gt;     /* exit */
#include &lt;sys/ioctl.h&gt;  /* ioctl */

#define DEVICE_FILE_NAME "/dev/something"
#define IOCTL_GET_MSG 1

/* Main - Call the ioctl functions */
void main() {
     int fd;
     int ret_val;
     char *msg = "Message passed by ioctl\n";

     fd = open(DEVICE_FILE_NAME, 0);
     if (file_desc &lt; 0) {

         printf ("Can't open device file: %s\n",  DEVICE_FILE_NAME);

         ret_val = ioctl(fd, IOCTL_GET_MSG, message);

         if (ret_val &lt; 0)
            printf("ioctl_get_msgfailed:%d\n",ret_val);

     }
}


</pre>

<p>
The expectation is that the hardware kernel would relay the expectation that
userspace has a request to fulfil and respond with the change or an error
message regarding why the request could not be completed.
</p>
</div>
</li>

<li><a id="org868286b"></a>What is sysfs/configfs ?<br />
<div class="outline-text-6" id="text-org868286b">
<p>
Link to source code of sysfs generics.
</p>
</div>
</li>

<li><a id="org47bdb7e"></a>What is <i>dev</i><br /></li>

<li><a id="orgc3e83f8"></a>What is Netlink messages ?<br />
<div class="outline-text-6" id="text-orgc3e83f8">
<ul class="org-ul">
<li>Limited subset of commands.</li>
<li>Examples provided by me will be done in kernel modules loaded at run time.</li>

<li>Find link to pedantism format required, but if you're doing evil best to
just do it in whatever you're comfortable with.</li>
</ul>

<p>
Netlink flaw:
<a href="https://bugzilla.redhat.com/show_bug.cgi?id=CVE-2009-1185">https://bugzilla.redhat.com/show_bug.cgi?id=CVE-2009-1185</a> 
</p>
</div>
</li>

<li><a id="orgd7b3054"></a>What is kernel space<br />
<div class="outline-text-6" id="text-orgd7b3054">
<ul class="org-ul">
<li>No floating point work done in kernel, those registers get smashed.</li>
<li>no stdlibs from glibc.</li>
<li><p>
can't use userspace libraries, code, read/write et
</p>

<p>
Full address space of the system.  Not directly accessible from userspace.
Syscalls, ioctls, sysfs have indirect access to the the kernel through through
their proxy style mechanism.
</p>

<p>
No "protection" provided from kernel-&gt;kernel access, can't limit execution of
kernel code.
</p>

<p>
Kernel proxies all memory access of applications via page tables, 
</p>

<p>
Linux kernel process memory map
<a href="https://www.kernel.org/doc/Documentation/x86/x86_64/mm.txt">https://www.kernel.org/doc/Documentation/x86/x86_64/mm.txt</a>
</p></li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org63e418e" class="outline-3">
<h3 id="org63e418e"><span class="section-number-3">3.2</span> Day +1 (Preparation)</h3>
<div class="outline-text-3" id="text-3-2">
</div>
<div id="outline-container-org2fbe394" class="outline-4">
<h4 id="org2fbe394">Setting up a kernel debugging environment</h4>
<div class="outline-text-4" id="text-org2fbe394">
</div>
<div id="outline-container-org067f3b7" class="outline-5">
<h5 id="org067f3b7">Setting up the kernel to be debugged.</h5>
<div class="outline-text-5" id="text-org067f3b7">
<p>
A kernel bug on oss-security list, claims to create a situation in which
memory corruption can panic the system. An integer used in determining the
size of TCP send and receive buffers can be set to be a negative value.
Red Hat engineering sometimes back-ports security and features from the
current kernel. These backports diverge the Red Hat Enterprise Linux
kernel from upstream and some security issues will no longer apply. This
document post shows how to use live kernel debugging to determine if a
system is at risk by this integer overflow flaw.
</p>


<p>
This walkthrough assumes that the reader has a Red Hat Enterprise Linux 7
guest and basic knowledge of C programming.
</p>
</div>

<ul class="org-ul">
<li><a id="orgbe34bad"></a>Setting up the guest target to debug.<br />
<div class="outline-text-6" id="text-orgbe34bad">
<p>
The guest to be the target of the debugging session is a libvirt (or
KVM/QEMU) style guest. The guest virtual serial port should be mapped to
the TCP port (TCP/1234) for use by the GDB .
</p>
</div>
</li>

<li><a id="orgb800d8e"></a>Modifying the guest domain file<br />
<div class="outline-text-6" id="text-orgb800d8e">
<p>
The virsh-edit command is intended to be a safe method of manipulating the
raw XML which is what we need to do in this circumstance. We need to
configure the guest via the domain configuration file as there are no
tickbox to enable what we need in virt-manager.
</p>

<p>
The first change is to set the xml namespace for QEMU, which sounds more complex than it is.
</p>

<pre class="example">
# virsh-edit your-virt-host-name
</pre>


<p>
Find the "domain" directive, and add the option xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0'
</p>

<pre class="example">
&lt;domain type='kvm'
  xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0' &gt;
</pre>

<p>
Add a new sub directive of "domain" which will allow us to pass a
parameter to qemu for this guest when starting.
</p>


<pre class="example">
&lt;domain type='kvm'
       xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0' &gt;
     &lt;qemu:commandline&gt;
          &lt;qemu:arg value='-s'/&gt;
     &lt;/qemu:commandline&gt;
</pre>


<p>
Save the file and exit the editor. Some versions of libvirt may complain the
XML has invalid attributes, ignore this and save the file anyway. The libvirtd
daemon does not need to be restarted. The guest will need to destroyed and
restarted if it is already running.
</p>

<p>
The -s parameter: it is a shortcut for -gdb tcp::1234 if you have many hosts
needing debugging on different ports or already have a service running on port
1234 on the guest, you can set the port explicitly as shown below:
</p>

<pre class="example">
&lt;qemu:commandline&gt;
      &lt;qemu:arg value='-gdb'/&gt;
      &lt;qemu:arg value='tcp::1235'/&gt;
&lt;/qemu:commandline&gt;
</pre>

<p>
If its working, a qemu process will be listening on port specified as shown below:
</p>

<pre class="example">


[root@target]# netstat -taupn |grep tcp |grep 1234
tcp        0      0 0.0.0.0:1234            0.0.0.0:*               LISTEN      11950/qemu-system-x
</pre>
</div>
</li>


<li><a id="org60fd5b0"></a>Change /etc/default/grub<br />
<div class="outline-text-6" id="text-org60fd5b0">
<p>
The kernel will need to booted with new parameters to enable kgdb debugging facilities. Add the values kgdboc=ttyS0,115200. In the system shown here, a serial console is also running on ttyS0 with no adverse affects.
</p>

<p>
Use the helpful grubby to apply these changes across all kernels.
</p>

<pre class="example">
# grubby --update-kernel=ALL --args="console=ttyS0,115200 kgdboc=ttyS0,115200"
</pre>
</div>
</li>

<li><a id="orgf4ce367"></a>Downloading debuginfo packages.<br />
<div class="outline-text-6" id="text-orgf4ce367">
<p>
The Red Hat Enterprise Linux kernel packages do not include debug symbols, debug symbols are stripped from binary files at build time. Gdb uses debug symbols to assist programmers when debugging. For more information on debuginfo see this segment of the Red Hat Enteprise Linux 7 developer guide](<a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Developer_Guide/intro.debuginfo.html">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Developer_Guide/intro.debuginfo.html</a>).
</p>

<p>
RPM packages containing the name 'debuginfo' contain files with symbols.
These packages can be downloaded from Red hat using yum or up2date.
</p>

<p>
To download these packages on the guest:
</p>

<pre class="example">
# debuginfo-install --downloadonly kernel-3.10.0-327.el7
</pre>


<p>
This should download two files in the current directory on the host for later extraction and use by gdb.
</p>

<p>
Copy these files from the target to the host for use. I choose the ~/kernel-debug/ as a sane location for these files. Create the directory if it doesn't already exist.
</p>

<pre class="example">
# mkdir ~/kernel-debug
# scp yourlogin@guest:kernel*.rpm kernel-debug/
</pre>

<p>
The final step on the guest is to reboot the target. At this point the
system should reboot with no change in behavior.
</p>
</div>
</li>

<li><a id="org4da1dc8"></a>Preparing the host to debug<br />
<div class="outline-text-6" id="text-org4da1dc8">
<p>
The system which runs the debugger, doesn't need to be the host that contains the guest. The host must capable of making a connection to the system running on the specified port (1234). In this example these commands will be run on the host which contains the virtual machine.
Installing gdb:
</p>

<p>
Install GDB on the host using a package manager.
</p>

<pre class="example">
# sudo yum -y install gdb
</pre>
<p>
Extracting files to be used from RPMS.
</p>

<p>
When Red Hat builds the kernel it strips debugging symbols from the RPMS. This creates smaller downloads and uses less memory on when running. The stripped versions are named kernel-X.YY-N-MMMMM.somearch.rpm. The non-stripped debug information is stored in debuginfo rpms. These were files downloaded earlier in this document by using debuginfo-install. It must match the kernel version and architecture being debugged exactly to be of any use.
</p>

<p>
The target may not match the host system architecture or release version. The example below can extract files from RPMS on such systems.
</p>

<pre class="example">
# cd ~/kernel-debug
# rpm2cpio kernel-debuginfo-3.10.0-327.el7.x86_64.rpm | cpio -idmv
# rpm2cpio kernel-debuginfo-common-3.10.0-327.el7.x86_64.rpm | cpio -idmv
</pre>

<p>
This extracts the files within packages into the current working directory as
they would on the intended file system. No scripts or commands within the RPM
run. These files are not installed and the system package management tools will
not manage them.
</p>

<p>
This creates a vmlinux in ~/kernel-debug/usr/lib/debug/lib/modules/3.10.0-510.el7.x86<sub>64</sub>/vmlinux
</p>

<p>
The kernel source is in the directory:
~/kernel-debug/usr/src/debug/kernel-3.10.0-327.el7/linux-3.10.0-327.el7.x86<sub>64</sub>/
</p>
</div>
</li>


<li><a id="org7326756"></a>Connecting to the target system from the remote system.<br />
<div class="outline-text-6" id="text-org7326756">
<p>
Start GDB with the text user interface with the parameter of the path to the
vmlinux/kernel running on the target system.
</p>

<pre class="example">
# gdb -tui ~/kernel-debug/var/lib/kernel-3.10.0-327.el7/boot/vmlinux
</pre>
<p>
&lt;gdb prelude shows here&gt;
</p>

<p>
GDB must be told where to find the target system. Type the following (or copy and paste !) it into the GDB session.
</p>

<pre class="example">
set architecture i386:x86-64:intel
target remote localhost:1234
dir ~/kernel-debug/usr/src/debug/kernel-3.10.0-327.el7/linux-3.10.0-327.el7.x86_64/
</pre>

<p>
Commands entered at the (gdb) prompt can be saved in ~/.gdbinit to reduce repetitive entry.
</p>

<p>
At this point if all goes well, the system should be connected to the remote
GDB session, not all GDB commands will be available, but this should be a good
starting point.
</p>
</div>
</li>
</ul>
</div>
</div>


<div id="outline-container-orgcb5327a" class="outline-4">
<h4 id="orgcb5327a">Kernel internals</h4>
<div class="outline-text-4" id="text-orgcb5327a">
</div>
<div id="outline-container-orgb083ff3" class="outline-5">
<h5 id="orgb083ff3">Memory models and the address space</h5>
</div>
<div id="outline-container-org562fdbc" class="outline-5">
<h5 id="org562fdbc">Device drivers</h5>
<div class="outline-text-5" id="text-org562fdbc">
<p>
Check makefile in driver directory
</p>

<p>
obj-y lines are forced internals
obj-($CONFIG<sub>SOMETHING</sub>) depends on the CONFIG<sub>SOMETHING</sub> being set in the
kernels <i>usr/src/linux</i>.config 
</p>
</div>
</div>
</div>
<div id="outline-container-org77f10b7" class="outline-4">
<h4 id="org77f10b7">Flaw types</h4>
<div class="outline-text-4" id="text-org77f10b7">
</div>
<div id="outline-container-org6e924c4" class="outline-5">
<h5 id="org6e924c4">Infoleak</h5>
<div class="outline-text-5" id="text-org6e924c4">
<p>
Reveals offsets and values of shit on stack.
</p>
</div>
</div>
<div id="outline-container-org02ba814" class="outline-5">
<h5 id="org02ba814">Privesc</h5>
<div class="outline-text-5" id="text-org02ba814">
<p>
Changing the running priv of the current program.
</p>
</div>
</div>

<div id="outline-container-orgfb80889" class="outline-5">
<h5 id="orgfb80889">X86 calling conventions.</h5>
<div class="outline-text-5" id="text-orgfb80889">
<p>
Talk here about the stack what order of arguements in which bit 32/64 that 
args are passed int he stack, probably link to wikipedia article here on
the current x86 calling conventions, and maybe find the arm one too.
</p>
</div>
</div>

<div id="outline-container-org78470a5" class="outline-5">
<h5 id="org78470a5">Key structures in privesc</h5>
<div class="outline-text-5" id="text-org78470a5">
</div>
<ul class="org-ul">
<li><a id="org800d697"></a>Task struct<br /></li>
<li><a id="orga94633f"></a>Thread info struct<br /></li>
</ul>
</div>
</div>

<div id="outline-container-org1cf553a" class="outline-4">
<h4 id="org1cf553a">Exploit stages</h4>
<div class="outline-text-4" id="text-org1cf553a">
</div>
<div id="outline-container-orga7d59fd" class="outline-5">
<h5 id="orga7d59fd">Was reading a book about the 4 stages of exploitation, cover that here.</h5>
<div class="outline-text-5" id="text-orga7d59fd">
</div>
<ul class="org-ul">
<li><a id="org7710ff2"></a>Stage 1: Setup/Initialization<br /></li>
<li><a id="orgf007b8a"></a>Stage 2: <span class="underline"><span class="underline"><span class="underline">_</span></span></span><br /></li>
<li><a id="org9d0b6ba"></a>Stage 3: Exploitation<br /></li>
<li><a id="org6180166"></a>Stage 4: Recovery / Cleanup ?<br /></li>
</ul>
</div>
</div>


<div id="outline-container-org6239f67" class="outline-4">
<h4 id="org6239f67">Common C Exploit types</h4>
<div class="outline-text-4" id="text-org6239f67">
<ul class="org-ul">
<li>Signedness issues
<a href="https://en.wikibooks.org/wiki/X86_Assembly/Control_Flow#Jump_if_Above_.28unsigned_comparison.29">https://en.wikibooks.org/wiki/X86_Assembly/Control_Flow#Jump_if_Above_.28unsigned_comparison.29</a></li>
<li>Integer overflow</li>
<li>Type promotion in comparison.</li>
<li>Overflowing into adjacent objects</li>
<li>Off-by-[one/X]</li>
<li>Use after free</li>
<li>Stack corruption</li>
<li>Heap Corruption</li>
<li>Information leak
Used to generate offsets to find task<sub>struct</sub> and set uid / gid to 0.</li>
<li>OOB accesss ?</li>
</ul>
</div>
</div>

<div id="outline-container-orgecfdb94" class="outline-4">
<h4 id="orgecfdb94">Kernel Mitigations</h4>
<div class="outline-text-4" id="text-orgecfdb94">
<p>
Describe each one of the kernel mitigatations.
</p>
</div>

<div id="outline-container-org89dfa71" class="outline-5">
<h5 id="org89dfa71">Stack guard page.</h5>
</div>

<div id="outline-container-orga8ebdd2" class="outline-5">
<h5 id="orga8ebdd2">SMEP</h5>
<div class="outline-text-5" id="text-orga8ebdd2">
<p>
Bypassing SMEP (Supervisor Mode Execution Protection)
:- <a href="http://vulnfactory.org/blog/2011/06/05/smep-what-is-it-and-how-to-beat-it-on-linux/">http://vulnfactory.org/blog/2011/06/05/smep-what-is-it-and-how-to-beat-it-on-linux/</a>
</p>
</div>
</div>

<div id="outline-container-org1dc16e0" class="outline-5">
<h5 id="org1dc16e0">SMAP</h5>
<div class="outline-text-5" id="text-org1dc16e0">
<ul class="org-ul">
<li><p>
<a href="https://github.com/wmealing/playground/tree/master/kernel-module-disable-smep">https://github.com/wmealing/playground/tree/master/kernel-module-disable-smep</a>
</p>

<p>
So, weird things, i think it gets re-enabled when copy<sub>to</sub><sub>user</sub> happens
(frequently), so maybe i need to work this into some kind of shellcode
that can be injected during the payload.  
</p>

<p>
The other option is that i need to continually run this by hooking it
into the re-enable code to ensure that it never gets disabled
</p>

<p>
LWN made a page on it <a href="https://lwn.net/Articles/517475/">https://lwn.net/Articles/517475/</a>
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org4036ef4" class="outline-5">
<h5 id="org4036ef4">Struct alignment.</h5>
</div>
<div id="outline-container-org23eaee5" class="outline-5">
<h5 id="org23eaee5">Hardening list ?</h5>
</div>
<div id="outline-container-orge8fc986" class="outline-5">
<h5 id="orge8fc986">Seccomp sandboxing</h5>
</div>
<div id="outline-container-org5c03c37" class="outline-5">
<h5 id="org5c03c37">address<sub>limit</sub> checks</h5>
<div class="outline-text-5" id="text-org5c03c37">
<p>
Vitaly talks about it here <a href="https://www.youtube.com/watch?v=UFakJa3t8Ls&amp;t=7s">https://www.youtube.com/watch?v=UFakJa3t8Ls&amp;t=7s</a>
</p>

<p>
get<sub>fs</sub>() and set<sub>fs</sub>() set the thread<sub>info</sub>'s addr<sub>limit</sub> which is checked
when copying to and from userspace/kernel space, by tricking this out, 
any application can have arbitrary read/write of kernel address space.
</p>
</div>
</div>

<div id="outline-container-orgef2fc6f" class="outline-5">
<h5 id="orgef2fc6f">Probable mitigations can be destroyed with rowhammer exploits or the newer</h5>
<div class="outline-text-5" id="text-orgef2fc6f">
<p>
intel CPU flaws.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd6715ec" class="outline-3">
<h3 id="orgd6715ec"><span class="section-number-3">3.3</span> Day +2 (Exploit toolchain)</h3>
<div class="outline-text-3" id="text-3-3">
</div>
<div id="outline-container-orga586c6e" class="outline-4">
<h4 id="orga586c6e">Abusing arbitrary read/write</h4>
<div class="outline-text-4" id="text-orga586c6e">
<p>
Show how infoleak + write can end up with a user discovering the location
of the task struct (then creds) then setting effective uid and gid.
</p>
</div>

<ul class="org-ul">
<li><a id="orga8b3c88"></a><span class="todo TODO">TODO</span> Create github example module that allows for 1 byte read  and  write.<br /></li>
</ul>
</div>

<div id="outline-container-orgf6480a2" class="outline-4">
<h4 id="orgf6480a2">Abusing function pointers</h4>
<div class="outline-text-4" id="text-orgf6480a2">
<p>
Show how abusing arbitary writes and then calling a function pointer
to controlled code can control EIP.
</p>

<p>
Mitigations will prevent this from happening.
</p>
</div>

<ul class="org-ul">
<li><a id="orgc1325da"></a><span class="todo TODO">TODO</span> create github example of module that allows for arb read/write and fn abuse.<br /></li>
</ul>
</div>

<div id="outline-container-org8d03182" class="outline-4">
<h4 id="org8d03182">Controlled memory 'corruption'</h4>
<div class="outline-text-4" id="text-org8d03182">
<p>
Sometimes only writes are not controlled, but corrupting,
how do we take advantage of that
</p>
</div>

<div id="outline-container-orgb8b4372" class="outline-5">
<h5 id="orgb8b4372"><span class="todo TODO">TODO</span> create example of writing 'something' to a location, then spinning on</h5>
<div class="outline-text-5" id="text-orgb8b4372">
<p>
it&#x2026; slab trashing ?
</p>
</div>
</div>
</div>

<div id="outline-container-org995fa00" class="outline-4">
<h4 id="org995fa00">Simple Race conditions</h4>
<div class="outline-text-4" id="text-org995fa00">
<p>
How do we abuse race conditions (show dirty cow ?)
</p>
</div>
</div>
</div>
<div id="outline-container-org0dcefee" class="outline-3">
<h3 id="org0dcefee"><span class="section-number-3">3.4</span> Day +3</h3>
<div class="outline-text-3" id="text-3-4">
</div>
<div id="outline-container-org4c9ed56" class="outline-4">
<h4 id="org4c9ed56">Logical and hardware related bugs</h4>
<div class="outline-text-4" id="text-org4c9ed56">
</div>
<div id="outline-container-orge891a75" class="outline-5">
<h5 id="orge891a75">CDROM infoleak ?</h5>
</div>
</div>
<div id="outline-container-org64305b6" class="outline-4">
<h4 id="org64305b6">Kernel and hardware protection</h4>
<div class="outline-text-4" id="text-org64305b6">
<ul class="org-ul">
<li>Reference capcom simple example, and make it.</li>
<li>Show how to prepare example with protections disabled.</li>
<li>smep, smap, nx, what happens when each of them are triggered.</li>
</ul>
</div>
</div>

<div id="outline-container-org5644a31" class="outline-4">
<h4 id="org5644a31">Bypassing protections</h4>
<div class="outline-text-4" id="text-org5644a31">
<p>
-&gt; Show shellcode how to disable CR3 (capcom<sub>ko</sub> ?)
</p>
</div>
</div>

<div id="outline-container-org58b8b9f" class="outline-4">
<h4 id="org58b8b9f">The future of kernel vulnerabilties</h4>
<div class="outline-text-4" id="text-org58b8b9f">
<ul class="org-ul">
<li>May be only logic bugs in the future</li>
<li>Verified/Trustworthy languages may make kernel exploitation harder.</li>
<li>Fortunately hardware manufacturers keep making unsafe hardware so &#x2026;</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org7feb170" class="outline-3">
<h3 id="org7feb170"><span class="section-number-3">3.5</span> Day +4 (Stuff that Doesn't fit )</h3>
<div class="outline-text-3" id="text-3-5">
</div>
<div id="outline-container-org430cde2" class="outline-4">
<h4 id="org430cde2">Rootkits</h4>
<div class="outline-text-4" id="text-org430cde2">
<p>
<a href="https://github.com/f0rb1dd3n/">https://github.com/f0rb1dd3n/</a>
</p>
</div>
<div id="outline-container-org11904b6" class="outline-5">
<h5 id="org11904b6">Tricks:</h5>
<div class="outline-text-5" id="text-org11904b6">
</div>
<ul class="org-ul">
<li><a id="orgf71c2a7"></a>Finding Offset in structs.<br />
<div class="outline-text-6" id="text-orgf71c2a7">
<p>
In crash,(and maybe GDB, stolen from   <a href="https://youtu.be/UFakJa3t8Ls?t=2995">https://youtu.be/UFakJa3t8Ls?t=2995</a>)
</p>

<pre class="example">
x/x &amp;((struct somestruct *)0x1000)-&gt;element
0x1000 (Plus offset)
</pre>
</div>
</li>

<li><a id="org64b6910"></a>Skipping over instructions to simulate requirements.<br />
<div class="outline-text-6" id="text-org64b6910">
<pre class="example">
so
</pre>
</div>
</li>
</ul>
</div>
</div>



<div id="outline-container-orga4b9591" class="outline-4">
<h4 id="orga4b9591">Basic commit creds example:</h4>
<div class="outline-text-4" id="text-orga4b9591">
<p>
Privilege escalation
</p>
<pre class="example">
TODO: basic example for commit_creds(prepare_kernel_cred)

</pre>

<p>
Privilege escalation heuristics
</p>
<pre class="example">
Dont know

</pre>
</div>
</div>
</div>

<div id="outline-container-orgadc66c5" class="outline-3">
<h3 id="orgadc66c5"><span class="section-number-3">3.6</span> References / to sort.</h3>
<div class="outline-text-3" id="text-3-6">
<ul class="org-ul">
<li>android kernel exploitation playground
:-  <a href="https://github.com/Fuzion24/AndroidKernelExploitationPlayground">https://github.com/Fuzion24/AndroidKernelExploitationPlayground</a></li>

<li>Great link on linux kernel exploitation 
:-  <a href="https://github.com/xairy/linux-kernel-exploitation">https://github.com/xairy/linux-kernel-exploitation</a></li>

<li>Vitaly's presentation on exploit generation stuff.
:- <a href="https://www.youtube.com/watch?v=UFakJa3t8Ls&amp;t=7s">https://www.youtube.com/watch?v=UFakJa3t8Ls&amp;t=7s</a></li>

<li>- Simple exploit 
:- ret2usr - <a href="https://github.com/vnik5287/kernel_rop/">https://github.com/vnik5287/kernel_rop/</a>
:- The advanced return-into-lib(c) exploits: PaX case study ( <a href="http://phrack.org/archives/issues/58/4.txt">http://phrack.org/archives/issues/58/4.txt</a> )</li>

<li>- Introduction to ret2usr attacks
:- <a href="https://cyseclabs.com/slides/smep_bypass.pdf">https://cyseclabs.com/slides/smep_bypass.pdf</a></li>

<li>- Exploiting kernel heap and stack vulnerabilities
:- <a href="https://cyseclabs.com/blog/cve-2016-6187-heap-off-by-one-exploit">https://cyseclabs.com/blog/cve-2016-6187-heap-off-by-one-exploit</a></li>

<li>- Reliable exploitation of use-after-free (UAF) vulnerabilities
:- <a href="http://perception-point.io/2016/01/14/analysis-and-exploitation-of-a-linux-kernel-vulnerability-cve-2016-0728/">http://perception-point.io/2016/01/14/analysis-and-exploitation-of-a-linux-kernel-vulnerability-cve-2016-0728/</a>
:- <a href="https://cyseclabs.com/page?n=02012016">https://cyseclabs.com/page?n=02012016</a></li>

<li>Reliable UAF exploitation on SMP systems
:- dont know how to do this, other than userfault fd maybe ?</li>

<li>Why and Introduction to ret2dir attacks
:- <a href="https://www.blackhat.com/docs/eu-14/materials/eu-14-Kemerlis-Ret2dir-Deconstructing-Kernel-Isolation-wp.pdf">https://www.blackhat.com/docs/eu-14/materials/eu-14-Kemerlis-Ret2dir-Deconstructing-Kernel-Isolation-wp.pdf</a>
:- <a href="https://www.youtube.com/watch?v=kot-EQ9zf9k">https://www.youtube.com/watch?v=kot-EQ9zf9k</a></li>

<li>Introduction to ROP
:- <a href="https://www.trustwave.com/Resources/SpiderLabs-Blog/Linux-Kernel-ROP---Ropping-your-way-to">https://www.trustwave.com/Resources/SpiderLabs-Blog/Linux-Kernel-ROP---Ropping-your-way-to</a>&#x2014;(Part-1)/
:- <a href="https://www.trustwave.com/Resources/SpiderLabs-Blog/Linux-Kernel-ROP---Ropping-your-way-to">https://www.trustwave.com/Resources/SpiderLabs-Blog/Linux-Kernel-ROP---Ropping-your-way-to</a>&#x2014;(Part-2)/
:- 64-bit Linux Return-Oriented Programming ( <a href="http://crypto.stanford.edu/~blynn/rop/">http://crypto.stanford.edu/~blynn/rop/</a> )</li>

<li>Bypassing SMEP (Supervisor Mode Execution Protection)
:- <a href="http://vulnfactory.org/blog/2011/06/05/smep-what-is-it-and-how-to-beat-it-on-linux/">http://vulnfactory.org/blog/2011/06/05/smep-what-is-it-and-how-to-beat-it-on-linux/</a></li>

<li>IDT (Interrupt Descriptor Table) overwrites
:- Is this still a thing ? <a href="http://phrack.org/issues/59/4.html">http://phrack.org/issues/59/4.html</a></li>
</ul>


<p>
(TO ADD/SORT)
</p>

<p>
Linux Kernel Heap Tampering Detection ( <a href="http://phrack.org/archives/issues/66/15.txt">http://phrack.org/archives/issues/66/15.txt</a> )
Automatic Bug-finding Techniques for Linux Kernel ( <a href="http://www.fi.muni.cz/~xslaby/sklad/teze.pdf">http://www.fi.muni.cz/~xslaby/sklad/teze.pdf</a> )
Vulnerability Extrapolation: Assisted Discovery of Vulnerabilities Using Machine Learning ( <a href="https://www.usenix.org/legacy/events/woot11/tech/final_files/Yamaguchi.pdf">https://www.usenix.org/legacy/events/woot11/tech/final_files/Yamaguchi.pdf</a> )
Offset2lib: bypassing full ASLR on 64bit Linux ( <a href="http://cybersecurity.upv.es/attacks/offset2lib/offset2lib.html">http://cybersecurity.upv.es/attacks/offset2lib/offset2lib.html</a> )
Defeating Solar Designer’s Non-executable Stack Patch Summary ( <a href="http://insecure.org/sploits/non-executable.stack.problems.html">http://insecure.org/sploits/non-executable.stack.problems.html</a> )
Introduction to return oriented programming (ROP) ( <a href="http://codearcana.com/posts/2013/05/28/introduction-to-return-oriented-programming-rop.html">http://codearcana.com/posts/2013/05/28/introduction-to-return-oriented-programming-rop.html</a> )
</p>

<ul class="org-ul">
<li>Need to know:
<a href="http://stackoverflow.com/questions/2535989/what-are-the-calling-conventions-for-unix-linux-system-calls-on-x86-64">http://stackoverflow.com/questions/2535989/what-are-the-calling-conventions-for-unix-linux-system-calls-on-x86-64</a>
Intel® 64 and IA-32 Architectures Software Developer Manuals ( <a href="http://www.intel.com/content/www/us/en/processors/architectures-software-developer-manuals.html">http://www.intel.com/content/www/us/en/processors/architectures-software-developer-manuals.html</a> )</li>
</ul>

<p>
– Module debugging
</p>
<pre class="example">
loading a module in gdb ( https://github.com/vnik5287/kernel_rop/ )
stepping through  / breakpoints

</pre>

<ul class="org-ul">
<li>Vitals talk on youtube. need to watch that again.</li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: 0F04</p>
<p class="date">Created: 2018-06-04 Mon 17:03</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
